# å¼‚æ­¥ç¼–ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

> å•çº¿ç¨‹JavaScriptå¼‚æ­¥æ–¹æ¡ˆ
>
> - æ€»æ‰€å‘¨çŸ¥JavaScriptæ˜¯å•çº¿ç¨‹çš„
>
> - é‡‡ç”¨å•çº¿ç¨‹æ¨¡å¼å·¥ä½œçš„åŸå› 
>
>   > æœ€æ—©æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨ç«¯çš„è„šæœ¬è¯­è¨€ï¼Œç›®çš„å°±æ˜¯ç”¨æ¥å®ç°é¡µé¢ä¸­çš„åŠ¨æ€äº¤äº’ï¼Œè€Œå®ç°é¡µé¢äº¤äº’çš„æ ¸å¿ƒå°±æ˜¯DOMæ“ä½œï¼Œè€Œè¿™å°±å†³å®šäº†å®ƒå¿…é¡»ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ï¼Œå¦åˆ™å°±ä¼šå‡ºç°å¾ˆå¤æ‚çš„çº¿ç¨‹åŒæ­¥é—®é¢˜(ä¸¾ä¸ªğŸŒ°ï¼šå¤šçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªdomå…ƒç´ ï¼Œä¸€ä¸ªåˆ é™¤ä¸€ä¸ªä¿®æ”¹ï¼Œæµè§ˆå™¨å°±æ— æ³•åˆ¤æ–­åº”è¯¥ä»¥å“ªä¸€ä¸ªçº¿ç¨‹çš„ç»“æœä¸ºå‡†)
>
> - å•çº¿ç¨‹çš„è¡¨ç°å½¢å¼
>   - JSæ‰§è¡Œç¯å¢ƒä¸­è´Ÿè´£æ‰§è¡Œä»£ç çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ª
>   - å…ˆæ¥ååˆ°æ’é˜Ÿï¼Œé‡åˆ°ä¸€ä¸ªè¶…çº§è€—æ—¶çš„ä»»åŠ¡ï¼Œå°†ä¸¥é‡å½±å“åé¢çš„ä»»åŠ¡è¿›ç¨‹ï¼Œå‡ºç°å‡æ­»çš„æƒ…å†µï¼ˆå¼‚æ­¥åº”è¿è€Œç”Ÿï¼‰

# å†…å®¹æ¦‚è¦

- åŒæ­¥æ¨¡å¼ä¸å¼‚æ­¥æ¨¡å¼
- äº‹ä»¶å¾ªç¯ä¸æ¶ˆæ¯é˜Ÿåˆ—
- å¼‚æ­¥ç¼–ç¨‹çš„å‡ ç§æ–¹å¼
- Promiseå¼‚æ­¥æ–¹æ¡ˆã€å®ä»»åŠ¡/å¾®ä»»åŠ¡é˜Ÿåˆ—
- Generatorå¼‚æ­¥æ–¹æ¡ˆã€Async/Awaitè¯­æ³•ç³–

# 1Â·åŒæ­¥æ¨¡å¼ä¸å¼‚æ­¥æ¨¡å¼

> JavaScriptå°†ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼åˆ†æˆäº†ä¸¤ç§

- åŒæ­¥æ¨¡å¼(Synchronous)
- å¼‚æ­¥æ¨¡å¼(Asynchronous)

> æ ¹æ®è¿è¡Œç¯å¢ƒæä¾›çš„APIæ˜¯ä»¥åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ¨¡å¼çš„æ–¹å¼å·¥ä½œæ¥åŒºåˆ†

## 1.1Â·åŒæ­¥æ¨¡å¼

> â€‹	ä»£ç ä¸­çš„ä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œåé¢çš„ä»»åŠ¡å¿…é¡»ç­‰å¾…å‰é¢çš„ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œæ‰èƒ½å¼€å§‹æ‰§è¡Œï¼Œä»£ç ä¸­çš„å¤§å¤šæ•°ä»»åŠ¡é‡‡å–çš„æ˜¯åŒæ­¥æ‰§è¡Œæ¨¡å¼

## 1.2Â·å¼‚æ­¥æ¨¡å¼

> â€‹	å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œä¸ä¼šå»ç­‰å¾…ä¸€ä¸ªä»»åŠ¡çš„ç»“æŸæ‰å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚å¯¹äºè€—æ—¶çš„ä»»åŠ¡ï¼Œåœ¨å¼€å¯è¿‡åå°±ä¼šç«‹å³å¾€åæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œåç»­é€»è¾‘ä¸€èˆ¬ä¼šé€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼å»å®šä¹‰(è€—æ—¶ä»»åŠ¡åœ¨å†…éƒ¨æ‰§è¡Œå®Œæˆä¹‹åå°±ä¼šæ‰§è¡Œå›è°ƒ)ã€‚

- å¦‚æœæ²¡æœ‰å¼‚æ­¥æ‰§è¡Œæ¨¡å¼ï¼Œå•çº¿ç¨‹çš„JavaScriptå°±æ— æ³•åŒæ—¶å¤„ç†å¤§é‡çš„è€—æ—¶ä»»åŠ¡

- å¼‚æ­¥æ‰§è¡Œä¼šé‡åˆ°çš„é—®é¢˜

  - ä»£ç çš„æ‰§è¡Œé¡ºåºæ··ä¹±

    > ä¼—å¤šé¢è¯•é¢˜çš„è®¾è®¡çµæ„Ÿæ¥æºã€‚

- JavaScriptæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯æµè§ˆå™¨å¹¶éæ˜¯å•çº¿ç¨‹çš„ï¼Œæµè§ˆå™¨å†…éƒ¨çš„APIä¼šæœ‰å•ç‹¬çš„çº¿ç¨‹å»æ‰§è¡Œè¿™äº›è€—æ—¶çš„æ“ä½œ

> é€»è¾‘è¿‡ç¨‹ä¸­çš„åç§°:
>
> â€‹	Call stack: æ‰§è¡Œæ ˆï¼Œè°ƒç”¨æ ˆ
>
> â€‹	Web APIs:ç”¨äºç½—åˆ—å¼‚æ­¥ä»»åŠ¡
>
> â€‹	Queue:æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç»™å¼‚æ­¥ä»»åŠ¡æ’åº
>
> â€‹	Event loop:äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œå½“è°ƒç”¨æ ˆä¸ºç©ºçš„æ—¶å€™ï¼Œä¾æ¬¡å°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å‡½æ•°ä»»åŠ¡è°ƒå¾€æ‰§è¡Œæ ˆ
>
> é€»è¾‘æ€»ç»“:
>
> â€‹	åœ¨ä»£ç æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œæ ˆå…ˆè¿›è¡Œå‹æ ˆï¼ˆæ§åˆ¶æ‰§è¡Œæ ˆä¸ä¸ºç©ºï¼Œæš‚ä¸è°ƒç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œåœ¨é‡åˆ°åŒæ­¥ä»»åŠ¡çš„æ—¶å€™æ”¾åˆ°æ‰§è¡Œæ ˆä¸­å¹¶æ‰§è¡Œï¼Œåœ¨é‡åˆ°å¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™ï¼Œå…ˆç½—åˆ—åˆ°Web APIsä¸­ã€‚å¾…åŒæ­¥ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ’¤é”€å‹æ ˆï¼Œå°†ç½—åˆ—çš„å¼‚æ­¥ä»»åŠ¡æŒ‰æ—¶é—´å…ˆååœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’åˆ—ï¼Œé€šè¿‡äº‹ä»¶å¾ªç¯æœºåˆ¶ä¾æ¬¡è°ƒåˆ°æ‰§è¡Œæ ˆå¹¶æ‰§è¡Œï¼Œé‡åˆ°æ–°çš„å¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ®æ—¶é—´åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒåŠ å¡ã€‚

![é€»è¾‘å›¾è§£](https://pics.images.ac.cn/image/5ec40ff668b7e.html)

# 2Â·å›è°ƒå‡½æ•°

> å›è°ƒå‡½æ•°ï¼š
>
> â€‹	æ‰€æœ‰å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆ(ä¸ºjså¼‚æ­¥è€Œç”Ÿçš„è¯­æ³•)çš„æ ¹åŸº
>
> â€‹	è°ƒç”¨è€…å®šä¹‰å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œæ ˆæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨è€…å‘Šè¯‰æ‰§è¡Œè€…å¼‚æ­¥ä»»åŠ¡ç»“æŸä¹‹ååº”è¯¥åšä»€ä¹ˆ

- æœ€åŸºæœ¬çš„å›è°ƒæ–¹å¼

  ```js
  /* 
      æœ€æ—©çš„å›è°ƒå‡½æ•°
          é€šè¿‡ä¼ é€’å›è°ƒå‚æ•°å®ç°
  */
  function foo (callback) {
      setTimeout(function () {
          callback()
      }, 3000)
  }
  // è°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¼ é€’å›è°ƒå‚æ•°
  foo(function () {
      console.log('è¿™å°±æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè°ƒç”¨è€…å®šä¹‰è¿™ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œæ ˆæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨è€…å‘Šè¯‰æ‰§è¡Œè€…å¼‚æ­¥ä»»åŠ¡ç»“æŸä¹‹ååº”è¯¥åšä»€ä¹ˆ')
  })
  ```

# 3Â·Promiseå¼‚æ­¥æ–¹æ¡ˆ

> Promise(æ‰¿è¯º)ï¼š
>
> â€‹	ä¸€ç§æ›´ä¼˜çš„å¼‚æ­¥ç¼–ç¨‹ç»Ÿä¸€æ–¹æ¡ˆ
>
> è§£å†³çš„ç—›ç‚¹ï¼š
>
> â€‹	ä¼ ç»Ÿçš„å›è°ƒæ–¹å¼æ— æ³•å®Œæˆå¤æ‚çš„å›è°ƒé€»è¾‘ï¼Œä¼šé€ æˆå›è°ƒåœ°ç‹±çš„æƒ…å†µ
>
> CommonJSç¤¾åŒºé¦–æ¬¡æå‡ºäº†Promiseçš„è§„èŒƒç”¨äºè§£å†³å›è°ƒåœ°ç‹±ï¼Œåœ¨ES2015ä¸­è¢«æ ‡å‡†åŒ–ï¼Œæˆä¸ºè¯­è¨€è§„èŒƒ
>
> æ¦‚å¿µï¼š
>
> â€‹	å›å­ä¸€è¯ºåƒé‡‘ï¼ŒPromiseçš„å›è°ƒæ‹¥æœ‰ä¸¤ç§ï¼Œå¤±è´¥ä¸æˆåŠŸï¼Œå®šä¹‰äº†æˆåŠŸå¦‚ä½•ï¼Œå¤±è´¥åˆå¦‚ä½•çš„è¡Œäº‹åŸåˆ™ã€‚

## 3.1Â·Promiseçš„åŸºæœ¬ç”¨æ³•

> Promiseä»£ç å±‚é¢çš„åŸºæœ¬ä½¿ç”¨
>
> Promiseä¹Ÿå¯ä»¥è¯´æ˜¯ES2015æ‰€æä¾›çš„ä¸€ä¸ª**å…¨å±€ç±»å‹**ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥å®ä¾‹å‡ºæ–°çš„æ‰¿è¯º

- Promiseçš„æ³¨æ„ç‚¹ï¼š

  - æ— è®ºæˆè´¥ï¼Œéƒ½åº”æœ‰å›åº”
  - æ— è®ºæˆè´¥ï¼Œéƒ½ä¸å¯é€†

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promiseçš„åŸºæœ¬ä½¿ç”¨
  */
  // è¿™ä¸ªç±»å‹çš„å‡½æ•°å’Œä»¥å¾€çš„æœ‰äº›ä¸ä¸åŒï¼Œå®ƒéœ€è¦æ¥æ”¶ä¸€ä¸ªå‡½æ•°(å…‘ç°æ‰¿è¯ºçš„é€»è¾‘)ä½œä¸ºå‚æ•°
  const promise = new Promise(function (resolve, reject) {
      // è¿™é‡Œç”¨æ¥'å…‘ç°'æ‰¿è¯º
  
      resolve('æ¡ä»¶è¾¾æˆäº†') // æ‰¿è¯ºè¾¾æˆ è¾“å‡ºç»“æœï¼šresolved æ¡ä»¶è¾¾æˆäº†
  
      reject(new Error('promise rejected')) // æ‰¿è¯ºå¤±è´¥ è¾“å‡ºç»“æœï¼šrejected Error: promise rejected
  })
  
  // å®ä¾‹åŒ–å¤„ç†å•Šçš„æ‰¿è¯ºï¼Œå¯ä»¥é€šè¿‡thenæ¥è·å–å›åº”ã€‚
  promise.then(function (value) {
      console.log('resolved', value) // è¿”å›æˆåŠŸçš„å›åº”
  }, function (error) {
      console.log('rejected', error) // è¿”å›å¤±è´¥çš„å›åº”
  })
  
  // æ‰¿è¯ºçš„æ³¨æ„ç‚¹ï¼š
  //     æ— è®ºå¤±è´¥ä¸æˆåŠŸï¼Œéƒ½æœ‰å…¶å¯¹åº”çš„å›åº”
  //     æ— è®ºæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œç»“æœä¸å¯é€†
  ```

## 3.2Â·Promiseçš„ä½¿ç”¨æ¡ˆä¾‹

> Promise æ–¹å¼çš„ AJAX

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promise æ–¹å¼çš„ AJAX
  */
  
  function ajax (url) {
      return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest()
          xhr.open('GET', url)
          xhr.responseType = 'json'
          xhr.onload = function () {
              if (this.status === 200) {
                  resolve(this.response) // æ‰¿è¯ºæˆåŠŸè¾¾æˆä¹‹åï¼Œè¿”å›å¾—åˆ°çš„æ•°æ®
              } else {
                  reject(new Error(this.statusText)) // æ‰¿è¯ºæ— æ³•è¾¾æˆä¹‹åï¼Œè¿”å›newå‡ºæ¥çš„é”™è¯¯ä¿¡æ¯
              }
          }
          xhr.send()
      })
  }
  
  // å¼‚æ­¥ä»»åŠ¡
  ajax('./api/foo.json')
      .then( // é»˜è®¤å‡½æ•°ç¬¬ä¸€ä¸ªæˆåŠŸï¼Œç¬¬äºŒä¸ªå¤±è´¥
          // æ‰¿è¯ºæˆåŠŸè¾¾æˆ,å¯¹äºè¿”å›çš„æˆåŠŸä¿¡æ¯çš„å¤„ç†
          function (res) {
              console.log(res) // æˆåŠŸä¹‹åï¼Œæœ´å®æ— åçš„æ‰“å°å‡ºæ¥è·å–åˆ°çš„æ•°æ® (2)Â [{â€¦}, {â€¦}]
          },
          // æ‰¿è¯ºå¤±ä¿¡äº†ï¼Œå¯¹äºå¤±è´¥çš„è¿”å›ä¿¡æ¯çš„å¤„ç†
          function (error) {
              console.log(error) // è¿”å›å¤±è´¥ä¿¡æ¯
          }
  
      )
  ```

## 3.3Â·Promiseé“¾å¼è°ƒç”¨

> ä¸åŒä»¥å¾€çš„é“¾å¼è°ƒç”¨ï¼š
>
> â€‹	é€šè¿‡thençš„å¤„ç†ï¼Œè¿”å›å¤„ç†è¿‡åçš„promiseï¼Œä»è€Œè§£å†³å›è°ƒåœ°ç‹±é—®é¢˜

- é“¾å¼è°ƒç”¨
  - Promiseå¯¹è±¡çš„thenæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå…¨æ–°çš„Promiseå¯¹è±¡
  - åé¢çš„thenæ–¹æ³•å°±æ˜¯åœ¨ä¸ºä¸Šä¸€ä¸ªthenè¿”å›çš„peomiseæ³¨å†Œå›è°ƒ
  - thençš„returnè¿”å›å†…å®¹
    - æ— è¿”å›å€¼ï¼Œåˆ™æ“ä½œçš„å°±æ˜¯ä¸Šä¸€ä¸ªå¤„ç†è¿‡åçš„
    - ç±»å‹ä¾æ—§ä¸º`promise`,åˆ™ä¸‹ä¸€ä¸ªthenå¤„ç†çš„å°±æ˜¯è¿”å›çš„è¿™ä¸ª,å¹¶ä¸”ä¼šæ’é˜Ÿç­‰å¾…è¿”å›çš„promiseç»“æŸä¹‹åå†å¤„ç†
    - å¹¶é`promise`ç±»å‹ï¼Œåˆ™æ˜¯ä¸‹ä¸€ä¸ªthençš„å‚æ•°

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promiseé“¾å¼è°ƒç”¨
  */
  
  // è¿™ä¸ªç±»å‹çš„å‡½æ•°å’Œä»¥å¾€çš„æœ‰äº›ä¸ä¸åŒï¼Œå®ƒéœ€è¦æ¥æ”¶ä¸€ä¸ªå‡½æ•°(å…‘ç°æ‰¿è¯ºçš„é€»è¾‘)ä½œä¸ºå‚æ•°
  const promise = new Promise(function (resolve, reject) {
      // è¿™é‡Œç”¨æ¥'å…‘ç°'æ‰¿è¯º
  
      resolve('æ¡ä»¶è¾¾æˆäº†') // æ‰¿è¯ºè¾¾æˆ è¾“å‡ºç»“æœï¼šresolved æ¡ä»¶è¾¾æˆäº†
  
      reject(new Error('promise rejected')) // æ‰¿è¯ºå¤±è´¥ è¾“å‡ºç»“æœï¼šrejected Error: promise rejected
  })
  
  // å®ä¾‹åŒ–å¤„ç†å•Šçš„æ‰¿è¯ºï¼Œå¯ä»¥é€šè¿‡thenæ¥è·å–å›åº”ã€‚
  promise.then(function (value) {
      console.log('resolved', value) // è¿”å›æˆåŠŸçš„å›åº”
  }, function (error) {
      console.log('rejected', error) // è¿”å›å¤±è´¥çš„å›åº”
  })
  
  //è·å–é€šè¿‡thenå¤„ç†ä¸€æ¬¡è¿‡åçš„è¿”å›å€¼
  var promise2 = promise.then(function (value) {
      console.log('resolved', value) // è¿”å›æˆåŠŸçš„å›åº”
  }, function (error) {
      console.log('rejected', error) // è¿”å›å¤±è´¥çš„å›åº”
  })
  /* 
      åœ¨ä»¥å¾€æˆ‘ä»¬ä½¿ç”¨é“¾å¼è°ƒç”¨ï¼Œæ˜¯å› ä¸ºä½¿ç”¨çš„æ–¹æ³•æ²¡æœ‰æ”¹å˜thisæ‰§è¡Œï¼Œå°±æ˜¯è¯´ç»è¿‡æŸä¸ªæ–¹æ³•ï¼Œè¿”å›çš„ä¾æ—§æ˜¯åŸæœ¬çš„å¯¹è±¡æœ¬èº«
      ä½†æ˜¯ï¼Œ
          promiseä¸­ï¼Œé€šè¿‡thenå¤„ç†çš„promiseå¹¶ä¸æ˜¯åŸæ¥çš„promiseï¼Œè€Œè¿™ä¹Ÿæ­£æ˜¯promiseé“¾å¼è°ƒç”¨çš„å…³é”®æ‰€åœ¨
          é€šè¿‡thençš„å¤„ç†ï¼Œè¿”å›å¤„ç†è¿‡åçš„promiseï¼Œä»è€Œè§£å†³å›è°ƒåœ°ç‹±é—®é¢˜
  */
  console.log(promise === promise2) // è¿”å›ç»“æœï¼šfalse
  
  // å…³äºthençš„è¿”å›å€¼
  console.log('------------------------------------------------')
  promise
      .then(
          function (value) {
              // æ— è¿”å›å€¼
              console.log('æ— è¿”å›å€¼')
              console.log(value)
          }
      )
      .then(
          function (value) {
              console.log('è¿”å›ä¸€ä¸ªpromiseç±»å‹çš„æ•°æ®')
              return promise
          }
      )
      .then(
          function (value) {
              console.log('åœ¨è¿™æ¬¡å›è°ƒä¸­è¿”å›ä¸€ä¸ªépromiseç±»å‹çš„æ•°æ®')
              return value + 'å¹¶åœ¨æ­¤è¿”å›ä¸€ä¸ªépromiseç±»å‹çš„æ•°æ®'
          }
      )
      .then(
          function (value) {
              console.log('æ¥æ”¶ä¸€ä¸ªépromiseç±»å‹çš„æ•°æ®: ' + value)
          }
      )
  ```

## 3.4Â·Promiseå¼‚å¸¸å¤„ç†

> å¤„ç†å¼‚å¸¸çš„ä¸‰ç§æ–¹å¼

- å¼‚å¸¸çš„å›è°ƒå‡½æ•°

  - thençš„ç¬¬äºŒä¸ªå‡½æ•°
  - ç´§è·Ÿåœ¨æ¯ä¸€ä¸ªthenåé¢çš„catch
  - å…¨å±€å¯¹è±¡çš„unhandledrejectionç»Ÿä¸€å¤„ç†ï¼ˆä¸æ¨èä½¿ç”¨ï¼‰
    - æ¨èåœ¨ä»£ç ä¸­æ˜ç¡®çš„æ•è·æ¯ä¸€ä¸ªå¯èƒ½çš„å¼‚å¸¸

- å‰ä¸¤ç§å›è°ƒæ–¹æ³•çš„ä¸åŒç‚¹

  - thençš„ç¬¬äºŒä¸ªå‡½æ•°åªæ•è·ä¸Šä¸€ä¸ªpromiseçš„é”™è¯¯
  - catchæ•è·å‰é¢çš„æ‰€æœ‰promiseçš„é”™è¯¯

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promiseå¼‚å¸¸å¤„ç†
  */
  
  function ajax (url) {
      return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest()
          xhr.open('GET', url)
          xhr.responseType = 'json'
          xhr.onload = function () {
              if (this.status === 200) {
                  resolve(this.response) // æ‰¿è¯ºæˆåŠŸè¾¾æˆä¹‹åï¼Œè¿”å›å¾—åˆ°çš„æ•°æ®
              } else {
                  reject(new Error(this.statusText)) // æ‰¿è¯ºæ— æ³•è¾¾æˆä¹‹åï¼Œè¿”å›newå‡ºæ¥çš„é”™è¯¯ä¿¡æ¯
              }
          }
          xhr.send()
      })
  }
  
  // å¼‚æ­¥ä»»åŠ¡
  ajax('./api/foo.json')
      .then(
          function (res) {
              console.log(res)
              // è¿”å›ä¸€ä¸ªé”™è¯¯çš„promise
              return ajax('./api/abel.json')
          },
          function (error) {
              console.log(error + ' ç¦»å¤ªè¿‘äº†ï¼Œä¸å¥½æ„æ€æŠ“') // å¹¶æ²¡æœ‰æ•è·ä¸Šé¢çš„å¼‚å¸¸
          }
      )
  // catchå¤„ç†é”™è¯¯
  ajax('./api/foo.json')
      .then(
          function err (res) {
              console.log(res)
              // è¿”å›ä¸€ä¸ªé”™è¯¯çš„promise
              return ajax('./api/abel.json')
          }
      )
      // æœ¬è´¨å°±æ˜¯ç´§è·Ÿç€çš„thenä¸­çš„promiseçš„å›è°ƒ
      .catch(
          function (error) {
              console.log(error + ' å°æ ·ï¼Œå“ªé‡Œè·‘') // ç»“æœè¾“å‡ºï¼šError: Not Found å°æ ·ï¼Œå“ªé‡Œè·‘
          }
      )
  
  /* 
      å…¨å±€å¯¹è±¡é”™è¯¯ç»Ÿä¸€å¤„ç†
  */
  // Webä¸­
  window.addEventListener('unhandledrejection', event => {
      const { reason, promise } = event
      console.log(reason, promise)
      // reason => Promise
      // promise => å‡ºç°å¼‚å¸¸çš„Promiseå¯¹è±¡
      event.preventDefault()
  }, false)
  // nodeä¸­
  process.on('unhandledRejection', (reason, promise) => {
      console.log(reason, promise)
      // reason => Promise
      // promise => å‡ºç°å¼‚å¸¸çš„Promiseå¯¹è±¡
  })
  ```

## 3.5Â·Promiseé™æ€æ–¹æ³•

> Promiseç›¸å…³çš„æ–¹æ³•

- Promise.resolve()

  - å°†ä»»æ„å‚æ•°å˜ä¸ºpromise
  - æ ¹æ®ä¼ å…¥ç±»å‹çš„ä¸åŒï¼Œæœ‰ä¸åŒçš„æ•ˆæœä¸æ„ä¹‰
    - ä¼ å…¥å­—ç¬¦ä¸²ç­‰ç±»å‹çš„ï¼Œå±äºä½œä¸ºå‚æ•°ï¼Œä¼ ç»™äº†è‡ªå·±çš„å›è°ƒå‡½æ•°
    - ä¼ å…¥ä¸€ä¸ªpromise,ç­‰äºpromiseæœ¬èº«
    - ä¼ å…¥ä¸€ä¸ªæ‹¥æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼Œç¬¬ä¸‰æ–¹promiseè½¬åŸç”Ÿpromiseçš„è§£å†³æ–¹æ¡ˆ

- Promise.reject()

  - å¿«é€Ÿåˆ›å»ºä¸€ä¸ªæ‰¿è¯ºæœªè¾¾æˆçš„åŸå› 

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promiseé™æ€æ–¹æ³•  
  */
  
  // -----------------------------------------------------
  /* 
      Promise.resolve()
          å°†ä»»æ„çš„å‚æ•°å˜ä¸ºpromise
  */
  // ä¼ å…¥å­—ç¬¦ä¸²ç­‰ç±»å‹çš„ï¼Œå±äºä½œä¸ºå‚æ•°ï¼Œä¼ ç»™äº†è‡ªå·±çš„å›è°ƒå‡½æ•°
  const foo = Promise.resolve('foo')
  foo
      .then(
          function (value) {
              console.log(value) // ç»“æœè¾“å‡ºï¼šfoo
          }
      )
  // ä¼ å…¥ä¸€ä¸ªpromise,ç­‰äºpromiseæœ¬èº«
  const foo1 = Promise.resolve(foo)
  foo1
      .then(
          function (value) {
              console.log(value) // ç»“æœè¾“å‡ºï¼šfoo
          }
      )
  // ä¼ å…¥ä¸€ä¸ªæ‹¥æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼Œç¬¬ä¸‰æ–¹promiseè½¬åŸç”Ÿpromiseçš„è§£å†³æ–¹æ¡ˆ
  Promise.resolve({
      then: function (onFulfilled, onRejected) {
          onFulfilled('foo')
      }
  })
      .then(function (value) {
          console.log(value) // ç»“æœè¾“å‡ºï¼šfoo
      })
  
  // ---------------------------------------------------------
  /* 
      Promise.reject()
          å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå¤±è´¥çš„åŸå› 
  */
  Promise.reject('è¿™å°±æ˜¯æˆ‘å¤±è´¥ç†ç”±')
      .catch(function (error) {
          console.log(error) // ç»“æœè¾“å‡ºï¼šè¿™å°±æ˜¯æˆ‘å¤±è´¥ç†ç”±
      })
  ```

## 3.6Â·Promiseå¹¶è¡Œæ‰§è¡Œ

> é½å¤´å¹¶è¿›çš„Promise

- Promise.all()
  - æˆ‘å…¨éƒ½è¦
- Promise.race()
  - åªè¦ä¸€ä¸ªå°±å¥½

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promiseå¹¶è¡Œæ‰§è¡Œ
  */
  
  function ajax (url) {
      return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest()
          xhr.open('GET', url)
          xhr.responseType = 'json'
          xhr.onload = function () {
              if (this.status === 200) {
                  resolve(this.response) // æ‰¿è¯ºæˆåŠŸè¾¾æˆä¹‹åï¼Œè¿”å›å¾—åˆ°çš„æ•°æ®
              } else {
                  reject(new Error(this.statusText)) // æ‰¿è¯ºæ— æ³•è¾¾æˆä¹‹åï¼Œè¿”å›newå‡ºæ¥çš„é”™è¯¯ä¿¡æ¯
              }
          }
          xhr.send()
      })
  }
  
  // -------------------------------------------------------
  /* å¦‚ä½•åˆ¤æ–­éƒ½ç»“æŸäº†
      ä¹‹å‰ï¼šè®¡æ•°å™¨
      ç°åœ¨ï¼šall
      */ 
  
  /* 
      Promise.all()
          å°†å¤šä¸ªpromiseåˆå¹¶ï¼Œä¸€è£ä¿±è£ä¸€æŸä¿±æŸ
  */
  var promise = Promise.all(
      [
          ajax('./api/foo.json'),
          ajax('./api/foo.json')        
      ]
  )
  promise
      .then(function (values) {
          console.log(values) // ç»“æœè¾“å‡ºï¼š(2)Â [Array(2), Array(2)] // è¿”å›allé‡Œé¢promiseè¿”å›çš„å†…å®¹ï¼Œç»„æˆçš„æ•°ç»„
      })
      .catch(function (error) {
          console.log(error) // ä½†å‡¡æœ‰ä¸€ä¸ªå‡ºé”™ï¼Œå°±ä¼šæŠ¥é”™
      })
  
  // ------------------------------------------------------------
  /* 
      Promise.race()
          å¼±æ°´ä¸‰åƒåªå–ä¸€ç“¢ï¼Œåªè¦æœ‰å®Œæˆçš„å°±ä¸å†ç­‰å¾…å…¶ä»–çš„å¼‚æ­¥ä»»åŠ¡äº†
  */
  const request = ajax('./api/posts.json')
  const timeout = new Promise((resolve, reject) => {
      setTimeout(() => reject(new Error('timeout')), 500)
  }) 
  
  Promise.race([
      request,
      timeout
  ])
      .then(value => {
          console.log(value) // è¾“å‡ºç»“æœï¼šè¿”å›æœ€æ—©å®Œæˆçš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¯ä»¥åœ¨å¼€å‘è€…å·¥å…·ä¸­æ›´æ”¹ç½‘é€Ÿæ¥ä½“éªŒ
      })
      .catch(error => {
          console.log(error)
      })
  
  // -------------------------------------------------------
  /* 
      æ··åˆä½¿ç”¨
  */
  ajax.apply('./api/urls/json')
      .then(value => {
          const urls = Object.values(value)
          const tasks = urls.map(url => ajax(url))
          return Promise.all(tasks)
      })
      .then(valuse => {
          console.log(values)
      })
  ```

## 3.7Â·Promiseæ‰§è¡Œæ—¶åº

> å®ä»»åŠ¡ & å¾®ä»»åŠ¡

- å®ä»»åŠ¡

  - è·Ÿåœ¨å®ä»»åŠ¡åé¢ï¼Œå¦‚æœæœ‰æ ¼å¤–çš„éœ€æ±‚ï¼Œå¯ä»¥è·Ÿç€ä¸€èµ·åŠç†ï¼Œæ— éœ€é‡æ–°æ’é˜Ÿï¼Œæé«˜æ•´ä½“çš„å“åº”èƒ½åŠ›
  - Promise & MutationObserver & process.nextTick(nodeç¯å¢ƒä¸­)

- å¾®ä»»åŠ¡

  - ç›®å‰ç»å¤§å¤šæ•°å¼‚æ­¥è°ƒç”¨éƒ½æ˜¯ä½œä¸ºå®ä»»åŠ¡æ‰§è¡Œï¼Œéœ€è¦é‡æ–°æ’é˜Ÿ

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Promiseæ‰§è¡Œæ—¶åº
          å®ä»»åŠ¡&å¾®ä»»åŠ¡
  */
  
  /* 
      å¾®ä»»åŠ¡: è·Ÿåœ¨å®ä»»åŠ¡åé¢ï¼Œå¦‚æœæœ‰æ ¼å¤–çš„éœ€æ±‚ï¼Œå¯ä»¥è·Ÿç€ä¸€èµ·åŠç†ï¼Œæ— éœ€é‡æ–°æ’é˜Ÿï¼Œæé«˜æ•´ä½“çš„å“åº”èƒ½åŠ›
          Promise & MutationObserver & process.nextTick(nodeç¯å¢ƒä¸­)
      å®ä»»åŠ¡ï¼šç›®å‰ç»å¤§å¤šæ•°å¼‚æ­¥è°ƒç”¨éƒ½æ˜¯ä½œä¸ºå®ä»»åŠ¡æ‰§è¡Œï¼Œéœ€è¦é‡æ–°æ’é˜Ÿ
  */
  console.log('å¼€å§‹æ‰§è¡ŒåŒæ­¥ä»»åŠ¡')
  
  setTimeout(() => {
      console.log('è¿™æ˜¯ä¸€ä¸ªå®šæ—¶å™¨å¼‚æ­¥ä»»åŠ¡')
  }, 0)
  
  Promise.resolve()
      .then(() => {
          console.log('promiseä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒ')
      })
      .then(() => {
          console.log('promiseä¸­çš„ç¬¬äºŒä¸ªå›è°ƒ')
      })
      .then(() => {
          console.log('promiseä¸­çš„ç¬¬ä¸‰ä¸ªå›è°ƒ')
      })
  
  console.log('åŒæ­¥ä»»åŠ¡ç»“æŸ')
  
  /* è¾“å‡ºç»“æœé¡ºåº
          å¼€å§‹æ‰§è¡ŒåŒæ­¥ä»»åŠ¡
          åŒæ­¥ä»»åŠ¡ç»“æŸ
          promiseä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒ
          promiseä¸­çš„ç¬¬äºŒä¸ªå›è°ƒ
          promiseä¸­çš„ç¬¬ä¸‰ä¸ªå›è°ƒ
          è¿™æ˜¯ä¸€ä¸ªå®šæ—¶å™¨å¼‚æ­¥ä»»åŠ¡
      ç–‘é—®ç‚¹ï¼š
          1.ä¸ºä»€ä¹ˆpromiseæ¯”å®šæ—¶å™¨ä»»åŠ¡æ›´å…ˆæ‰§è¡Œ
              ç”±äºpromiseæœ¬èº«å¯ä»¥ä½œä¸ºå¾®ä»»åŠ¡ï¼Œå› æ­¤ï¼Œå®ƒæ‹¥æœ‰æ¯”å®šæ—¶å™¨æ›´ä¼˜å…ˆçš„æ—¶åºæ’åˆ—ã€‚
          2.ä¸ºä»€ä¹ˆpromiseçš„å›è°ƒçš„å›è°ƒéƒ½è·Ÿç€æå‰äº†
              ç­”ï¼šå›è°ƒé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ç§°ä¹‹ä¸ºå®ä»»åŠ¡ï¼Œè€Œå®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶åŠ ä¸Šçš„é¢å¤–éœ€æ±‚æˆä¸ºå¾®ä»»åŠ¡ï¼Œå¯ä»¥ç›´æ¥è·Ÿç€æ‰§è¡Œï¼Œæ— éœ€æ’é˜Ÿï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©ä½œä¸ºä¸€ä¸ªæ–°çš„å®ä»»åŠ¡è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­æ’é˜Ÿ
              è¿½é—®ï¼šä»€ä¹ˆå¼‚æ­¥ä»»åŠ¡èƒ½é‡æ–°é€‰æ‹©ä½œä¸ºå®ä»»åŠ¡ï¼Œä»€ä¹ˆèƒ½ä½œä¸ºå¾®ä»»åŠ¡è·Ÿç€æ‰§è¡Œ
              ç­”ï¼šå®šæ—¶å™¨ä»»åŠ¡ä¼šåšå›å®ä»»åŠ¡ä»æ–°æ’é˜Ÿï¼Œè€Œpromiseçš„å›è°ƒä¼šä½œä¸ºå¾®ä»»åŠ¡è·Ÿç€æ‰§è¡Œ
  */
  ```

## 3.8Â·Promiseå¸¸è§è¯¯åŒº

> Promiseçš„æœ¬è´¨ä¹Ÿæ˜¯é€šè¿‡å›è°ƒå‡½æ•°ï¼Œæ¥å®šä¹‰å¼‚æ­¥ä»»åŠ¡ç»“æŸä¹‹åæ‰€éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡

æ³¨æ„ç‚¹ï¼š
- Promiseå›è°ƒæ–¹æ³•ï¼Œé€šè¿‡ `then` æ¥ä¼ é€’
- Promiseåˆ†ä¸ºæˆåŠŸä¸å¤±è´¥çš„å›è°ƒ
- Promiseæ— éœ€åµŒå¥—ä½¿ç”¨,é€šè¿‡é“¾å¼è°ƒç”¨ï¼Œæ¥ä¿æŒå¼‚æ­¥çš„æ‰å¹³åŒ–
- å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡å¯¹äºæ‰§è¡Œé¡ºåºçš„å½±å“

# 4Â·Generatorå¼‚æ­¥æ–¹æ¡ˆ

> è¿›ä¸€æ­¥æå‡å¼‚æ­¥ä»»åŠ¡çš„ä»£ç å¯è¯»æ€§

## 4.1Â·Generator å¼‚æ­¥è§£å†³æ–¹æ¡ˆå›é¡¾

> ES2015Generatorçš„å›é¡¾ä¸è¡¥å……

- åœ¨æ™®é€šå‡½æ•°çš„å‡½æ•°åå‰é¢åŠ `*` ,å¯ä»¥æŠŠæ™®é€šå‡½æ•°å˜ä¸ºç”Ÿæˆå™¨å‡½æ•°

- ç”Ÿæˆå™¨å‡½æ•°çš„å‡½æ•°ä½“ï¼Œé€šè¿‡next()è°ƒç”¨åæ‰èƒ½æ‰§è¡Œ

- `yield`å…³é”®è¯ï¼Œæ‰“æ–­ç‚¹

- `throw()`ç”¨äºè¿”å›é”™è¯¯,å¯ä»¥è¢«å‡½æ•°ä½“ä¸­çš„try...catchæ•è·åˆ°

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Generator å¼‚æ­¥è§£å†³æ–¹æ¡ˆå›é¡¾
  */
  
  function * foo () {
      console.log('start')
  
      try {
          const res = yield 'foo'
          console.log(res)
      } catch (e) {
          console.log(e)
      }
  }
  
  const generator = foo()
  
  console.log(generator.next()) // åœ¨ç”Ÿæˆå™¨å‡½æ•°ä¸­ï¼Œé‡åˆ°yieldä¼šåœ¨æ‰§è¡Œå®Œè¿™ä¸€ä¸ªyieldä¹‹åæš‚åœ // è¾“å‡ºç»“æœï¼š{value: "foo", done: false}
  
  console.log(generator.throw(new Error('æŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯'))) // throwåŒæ ·å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¸è¿‡æ‰“å°å‡ºæ¥çš„ä¼šæ˜¯é”™è¯¯ä¿¡æ¯ // è¾“å‡ºç»“æœï¼šError: æŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯
  ```

## 4.2Â·ä½“éªŒGeneratorå¼‚æ­¥æ–¹æ¡ˆ

> ä½¿ç”¨Generatorçš„ç‰¹æ€§æ¥ä½“éªŒæ›´ä¼˜çš„å¼‚æ­¥è§£å†³æ–¹æ¡ˆ

- é€»è¾‘åˆ†æ

  > Generatorç”¨äºå¼‚æ­¥æ–¹æ¡ˆï¼Œå¾—ç›Šäºå®ƒçš„å…³é”®è¯yieldåé¢çš„è¿”å›å€¼ï¼Œvalueï¼Œå°†ä½œä¸ºå‚æ•°ä¼ é€’ä¸‹å»ï¼Œè¿™ç¬¦åˆäº†promiseé“¾å¼çš„éœ€æ±‚ï¼Œæ¯ä¸€æ¬¡é€šè¿‡è°ƒç”¨next()æ‰èƒ½ç»§ç»­å¾€ä¸‹è¿›è¡Œï¼Œè¿™ç»™äº†ç”¨äºåé¦ˆæ¯æ¬¡å¼‚æ­¥è¯·æ±‚çš„å›è°ƒå‡½æ•°ä»¥æ‰§è¡Œçš„æ§ä»¶ï¼Œé€šè¿‡åœ¨ç”Ÿæˆå™¨ä¸­æŒ‡å®štry...catchï¼Œåœ¨æ‰§è¡Œæ—¶è°ƒç”¨throw()æ–¹æ³•ä¹Ÿå¯ä»¥æ•è·å¼‚å¸¸ï¼Œå†é€šè¿‡è‡ªè°ƒç”¨è¿­ä»£ï¼Œå°±å¯ä»¥å®Œæˆå¼‚æ­¥è¯·æ±‚çš„è¿›ä¸€æ­¥æ‰å¹³åŒ–ï¼Œå¦‚åŒæ­¥å‡½æ•°ä¸€æ ·ã€‚

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      ä½“éªŒGeneratorå¼‚æ­¥æ–¹æ¡ˆ
  */
  
  function ajax (url) {
      return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest()
          xhr.open('GET', url)
          xhr.responseType = 'json'
          xhr.onload = function () {
              if (this.status === 200) {
                  resolve(this.response) // æ‰¿è¯ºæˆåŠŸè¾¾æˆä¹‹åï¼Œè¿”å›å¾—åˆ°çš„æ•°æ®
              } else {
                  reject(new Error(this.statusText)) // æ‰¿è¯ºæ— æ³•è¾¾æˆä¹‹åï¼Œè¿”å›newå‡ºæ¥çš„é”™è¯¯ä¿¡æ¯
              }
          }
          xhr.send()
      })
  }
  
  // å®šä¹‰ä¸€ä¸ªç”Ÿæˆå™¨
  function * main () {
      try {
          const foo = yield ajax('./api/foo.json')
          console.log(foo)
      
          const posts = yield ajax('./api/posts.json')
          console.log(posts)
          // åˆ›é€ ä¸€ä¸ªå¼‚å¸¸
          const postt = yield ajax('./api/postt.json')
          console.log(postt)
      } catch (e) {
          console.log(e)
      }
  
  }
  
  const g = main() // åˆ›å»ºç”Ÿæˆå™¨å‡½æ•°
  
  
  // ----------------------------------------------------------------------------------
  /* 
  generatoråˆä½“éªŒ
  */
  // result.value => è¿”å›çš„å°±æ˜¯yieldåé¢çš„promiseå¼‚æ­¥ä»»åŠ¡
  /* const result = g.next() // è¿›å…¥å‡½æ•°ä½“
      result.value
      .then(data => {
          // console.log(data) // dataå°±æ˜¯ä¸Šä¸€æ¬¡è§¦å‘next()è§¦å‘çš„å¼‚æ­¥è¯·æ±‚çš„ç»“æœ // è¾“å‡ºç»“æœï¼šfoo.jsonæ–‡ä»¶çš„å†…å®¹
          // å°†ä¸Šä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„ç»“æœä½œä¸ºå‚æ•°ï¼Œä¼ ç»™ä¸‹ä¸€ä¸ªpromise,ç¬¦åˆäº†promiseçš„é“¾å¼è°ƒç”¨
          const result2 = g.next(data)
          // åˆ¤æ–­è¿”å›å†…å®¹ï¼Œdoneæ˜¯å¦ä¸ºtrueï¼Œå†³å®šæ˜¯å¦ç»“æŸ
          if (result2.done) return console.log('ç»“æŸäº†')
          // å¤„ç†ç¬¬äºŒä¸ªpromiseçš„å›è°ƒ
          result2.value
              .then(data => {
                  const result3 = g.next(data)
                  if (result3.done) return console.log('ç»“æŸäº†')
                  // ...... æ— é™å¾ªç¯åµŒå¥—,å› æ­¤éœ€è¦é€’å½’è§£å†³
              })
  
      }) */
  
  
  // -------------------------------------------------------------------------------
  /* 
      é€’å½’æ‰§è¡Œgenerator
  */
  // å®šäºä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥é€’å½’æ‰§è¡Œgenerator
  /* function handleResult  (result) {
      if (result.done) return // ç”Ÿæˆå™¨å‡½æ•°ç»“æŸ
      result.value
          .then(data => {
               handleResult(g.next(data)) // åµŒå¥—ä½¿ç”¨ï¼Œå¦‚æœè¿›å…¥åˆ°è¿™ä¸€æ­¥ï¼Œç›¸å½“äºåˆé‡æ–°è°ƒç”¨äº†ä¸€ä¸‹è¿™ä¸ªå‡½æ•°
          }, error => {
              g.throw(error) // æ‰“å°å¼‚å¸¸çš„è¯ï¼Œéœ€è¦æ”¹é€ generator,æ·»åŠ try...catchç”¨æ¥å¤„ç†å¼‚å¸¸ // æ‰“å°ç»“æœï¼šError: Not Found at XMLHttpRequest.xhr.onload (10.js:14)
          })
  }
  
  handleResult(g.next()) */
  
  // -----------------------------------------------------------------
  /* 
      å¤ç”¨ç”Ÿæˆå™¨å‡½æ•° ï¼š co
          https://github.com/tj/co // ç¤¾åŒºä¸­å…³äºgeneratoç”Ÿæˆå™¨å¤ç”¨å‡½æ•°çš„å®Œæ•´çš„åº“
          è¢«Async await å–ä»£
  */
  function co (generator) {
      const g = generator()
  
      function handleResult (result) {
          if (result.done) return
          result.value
              .then(data => {
                  handleResult(g.next(data)) // å¾ªç¯è°ƒç”¨
              }, error => {
                  g.throw(error)
              })
      }
      //  å†…éƒ¨è‡ªè°ƒç”¨
      handleResult(g.next())
  }
  // ä¼ å…¥ä¸€ä¸ªgenerator
  co(main)
  ```

# 5Â·Asyncè¯­æ³•ç³–

> ç»ˆæçš„å¼‚æ­¥è§£å†³æ–¹æ¡ˆã€‚
>
> è¯­è¨€å±‚é¢çš„å¼‚æ­¥ç¼–ç¨‹æ ‡å‡†

- è¯­æ³•ç±»ä¼¼äºgenerator

  - å…³é”®è¯ä»`*&yield`å˜æˆäº†`async & await`

  - ç›®å‰`await`æ— æ³•å•ç‹¬ä½¿ç”¨ï¼Œåªèƒ½åœ¨asyncå®šä¹‰çš„å‡½æ•°ä¸­ä½¿ç”¨

- ä½¿ç”¨Asyncä¿®é¥°çš„å‡½æ•°ï¼Œè¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªpromise

- ä¸å†éœ€è¦é…åˆæ‰§è¡Œå™¨ï¼Œç›´æ¥è°ƒç”¨ä¿®é¥°çš„å‡½æ•°ï¼Œå°±æ˜¯æ‰§è¡Œçš„å…¨éƒ¨è¿‡ç¨‹

- æ ¼å¼ç¤ºä¾‹

  ```js
  /* 
      Asyncè¯­æ³•ç³–
  */
  
  /* 
      ç»ˆæçš„å¼‚æ­¥è§£å†³æ–¹æ¡ˆã€‚
      è¯­è¨€å±‚é¢çš„å¼‚æ­¥ç¼–ç¨‹æ ‡å‡†
  */
  
  /* 
      è¯­æ³•ç±»ä¼¼äºgenerator
      è¿”å›ä¸€ä¸ªpromise
      ä¸å†éœ€è¦é…åˆæ‰§è¡Œå™¨
  */
  
  function ajax (url) {
      return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest()
          xhr.open('GET', url)
          xhr.responseType = 'json'
          xhr.onload = function () {
              if (this.status === 200) {
                  resolve(this.response) // æ‰¿è¯ºæˆåŠŸè¾¾æˆä¹‹åï¼Œè¿”å›å¾—åˆ°çš„æ•°æ®
              } else {
                  reject(new Error(this.statusText)) // æ‰¿è¯ºæ— æ³•è¾¾æˆä¹‹åï¼Œè¿”å›newå‡ºæ¥çš„é”™è¯¯ä¿¡æ¯
              }
          }
          xhr.send()
      })
  }
  
  async function main () {
      try {
          const foo = await ajax('./api/foo.json')
          console.log(foo)
      
          const posts = await ajax('./api/posts.json')
          console.log(posts)
          // åˆ›é€ ä¸€ä¸ªå¼‚å¸¸
          const postt = await ajax('./api/postt.json')
          console.log(postt)
      } catch (e) {
          console.log(e)
      }
  }
  
  main()
  ```



â€‹	generator.throw() ç”¨äºæŠ›å‡ºå¼‚å¸¸